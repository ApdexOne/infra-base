apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: test
  generateName: pull-build-test-
  namespace: argo
spec:
  serviceAccountName: workflow
  entrypoint: run-e2e-tests
  arguments:
    parameters:
      - name: repo
        value: "http://gitea-http.services.svc:3000/ApdexOne/pipeline-demo.git"
      - name: revision
        value: "HEAD"
  volumes:
  - name: regcred
    secret:
      secretName: regcred
      items:
        - key: .dockerconfigjson
          path: config.json
  templates:
    - name: run-e2e-tests
      inputs:
        artifacts:
          - name: source
            path: /src
            git:
              repo: http://gitea-http.services.svc:3000/ApdexOne/pipeline-demo.git
              revision: "HEAD"
              insecureIgnoreHostKey: true
              usernameSecret:
                name: github-access
                key: user
              passwordSecret:
                name: github-access
                key: token
              sshPrivateKeySecret:
                name: github-access
                key: email
      script:
        image: cypress/included:3.4.0
        command: [bash]
        source: |
          yarn install
          npm run runHeadless
        workingDir: /src
